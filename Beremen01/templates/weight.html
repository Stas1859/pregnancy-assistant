<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–µ—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram-SDK –∏ –∫–ª–∞–¥—ë–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ sessionStorage -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, sans-serif;
      background: #f2f3f5;
      color: #333;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      margin-top: 24px;
      font-size: 20px;
    }

    .weight-block {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
      margin-bottom: 20px;
    }

    .date {
      text-align: left;
      font-size: 14px;
      color: #888;
      margin-bottom: 12px;
    }

    .weight-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .weight-btn {
      font-size: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: #e0f0ff;
      color: #2aabee;
      cursor: pointer;
    }

    .weight-input {
      font-size: 32px;
      width: 120px;
      text-align: center;
      border: none;
      background: transparent;
      outline: none;
      font-weight: bold;
      color: #333;
    }

    .weight-input.placeholder {
      opacity: 0.5;
    }

    .submit-btn {
      margin-top: 12px;
      background: #2aabee;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 24px;
      font-size: 16px;
      cursor: pointer;
    }

    .info-block {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .disclaimer {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 32px;
    }
  </style>
</head>
<body>
    <script>
      (function () {
        const tg = window.Telegram?.WebApp;
        if (tg?.initDataUnsafe?.user?.id) {
          sessionStorage.setItem("tg_user_id", tg.initDataUnsafe.user.id.toString());
          sessionStorage.setItem("dev_mode", "false");
        } else {
          // –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
          sessionStorage.setItem("tg_user_id", "test_user_12345");
          sessionStorage.setItem("dev_mode", "true");
          console.log("üîß –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
        }
      })();
    </script>
  <div style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
    <button onclick="goBack()" style="background: none; border: none; font-size: 16px; color: #4f8fba; cursor: pointer; position: absolute; left: 0;">
      ‚Üê –ù–∞–∑–∞–¥
    </button>
    <h2 style="margin: 0 auto; text-align: center;">–í–µ—Å</h2>
  </div> 
  <div class="weight-block">
    <div class="date" id="weightDateLabel">–í–≤–µ–¥–∏—Ç–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å:</div>
    <div class="weight-controls">
      <button class="weight-btn" onclick="adjustWeight(-0.1)">‚àí</button>
      <input
        id="weightInput"
        class="weight-input placeholder"
        type="text"
        inputmode="decimal"
        placeholder="‚Äì"
        oninput="onWeightEdit(this)"
      />
      <button class="weight-btn" onclick="adjustWeight(+0.1)">+</button>
    </div>
    <button class="submit-btn" onclick="submitWeight()">–í–Ω–µ—Å—Ç–∏</button>
  </div>

  <div class="info-block" id="heightBlock">
    <div id="heightDisplay">
      <button class="submit-btn" onclick="showHeightInput()">üìè –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Ä–æ—Å—Ç, —ç—Ç–æ —É—Ç–æ—á–Ω–∏—Ç —Ä–∞—Å—á—ë—Ç—ã</button>
    </div>

    <div id="heightInputBlock" style="display: none; margin-top: 10px;">
      <input
        id="heightInput"
        type="number"
        min="100"
        max="250"
        placeholder="–í–∞—à —Ä–æ—Å—Ç –≤ —Å–º"
        style="padding: 8px; font-size: 16px; width: 100%; max-width: 200px;"
      />
      <button class="submit-btn" onclick="submitHeight()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <div id="statsWrapper" style="display: none;">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="info-block" id="statsBlock">
      <div id="gainLine">üìà –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±–∞–≤–∫–∞: <strong>‚Äì</strong></div>
      <div id="normLine">‚Äì</div>
    </div>
    <canvas id="weightChart" style="max-width: 100%; margin-bottom: 20px;"></canvas>
  </div>

  <h2>–û –Ω–∞–±–æ—Ä–µ –≤–µ—Å–∞ –ø—Ä–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏</h2>
  <div class="info-block">
    <p><strong>üçº –ö–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –≤–µ—Å –ø—Ä–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏: —á–µ—Å—Ç–Ω–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ –ø–æ –Ω–µ–¥–µ–ª—è–º</strong></p>

    <p>–í–µ—Å ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω–æ–π. –û–Ω –Ω–µ —Ç–æ–ª—å–∫–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç, –∫–∞–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –±—É–¥—É—â–∞—è –º–∞–º–∞, –Ω–æ –∏ –¥–∞—ë—Ç –≤—Ä–∞—á—É –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –º–∞–ª—ã—à. –ù–æ —á—Ç–æ —Å—á–∏—Ç–∞—Ç—å –Ω–æ—Ä–º–æ–π? –ü–æ—á–µ–º—É –æ–¥–Ω–∞ –ø—Ä–∏–±–∞–≤–∏–ª–∞ 4 –∫–≥, –∞ –¥—Ä—É–≥–∞—è ‚Äî 10? –†–∞–∑–±–∏—Ä–∞–µ–º—Å—è.</p>

    <p><strong>üß† –ü–æ—á–µ–º—É –≤–æ–æ–±—â–µ —Ä–∞—Å—Ç—ë—Ç –≤–µ—Å?</strong><br>
    –ö –≤–µ—Å—É –ø—Ä–∏–±–∞–≤–ª—è—é—Ç—Å—è:
    <ul>
      <li>–ü–ª–∞—Ü–µ–Ω—Ç–∞ (0.5‚Äì0.7 –∫–≥)</li>
      <li>–ö—Ä–æ–≤—å (–¥–æ 1.5 –∫–≥)</li>
      <li>–û–∫–æ–ª–æ–ø–ª–æ–¥–Ω—ã–µ –≤–æ–¥—ã (0.8‚Äì1.5 –∫–≥)</li>
      <li>–ú–æ–ª–æ—á–Ω—ã–µ –∂–µ–ª–µ–∑—ã (+0.5‚Äì1 –∫–≥)</li>
      <li>–ñ–∏—Ä–æ–≤—ã–µ –∑–∞–ø–∞—Å—ã (2‚Äì4 –∫–≥)</li>
      <li>–†–µ–±—ë–Ω–æ–∫ (3‚Äì4 –∫–≥)</li>
    </ul>
    üì¶ –ò—Ç–æ–≥–æ: 10‚Äì15 –∫–≥ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
    </p>

    <p><strong>üßÆ –°–∫–æ–ª—å–∫–æ –Ω–∞–±–∏—Ä–∞—Ç—å ‚Äî –ø–æ –Ω–µ–¥–µ–ª—è–º?</strong></p>
    <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 4px; border: 1px solid #ccc;">–ò–ú–¢</th>
          <th style="padding: 4px; border: 1px solid #ccc;">–û–±—â–∞—è –ø—Ä–∏–±–∞–≤–∫–∞</th>
          <th style="padding: 4px; border: 1px solid #ccc;">–í –Ω–µ–¥–µ–ª—é</th>
        </tr>
      </thead>
      <tbody>
        <tr><td style="padding: 4px; border: 1px solid #ccc;">–î–µ—Ñ–∏—Ü–∏—Ç (&lt;18.5)</td><td style="padding: 4px;">12.5‚Äì18 –∫–≥</td><td style="padding: 4px;">0.5‚Äì0.6 –∫–≥</td></tr>
        <tr><td style="padding: 4px; border: 1px solid #ccc;">–ù–æ—Ä–º–∞ (18.5‚Äì24.9)</td><td style="padding: 4px;">11.5‚Äì16 –∫–≥</td><td style="padding: 4px;">0.4‚Äì0.5 –∫–≥</td></tr>
        <tr><td style="padding: 4px; border: 1px solid #ccc;">–ò–∑–±—ã—Ç–æ–∫ (25‚Äì29.9)</td><td style="padding: 4px;">7‚Äì11.5 –∫–≥</td><td style="padding: 4px;">0.2‚Äì0.3 –∫–≥</td></tr>
        <tr><td style="padding: 4px; border: 1px solid #ccc;">–û–∂–∏—Ä–µ–Ω–∏–µ (&gt;30)</td><td style="padding: 4px;">5‚Äì9 –∫–≥</td><td style="padding: 4px;">0.1‚Äì0.2 –∫–≥</td></tr>
      </tbody>
    </table>

    <p><strong>üìà –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –≤–µ—Å —Å–∫–∞—á–µ—Ç?</strong><br>
    –ë—ã—Å—Ç—Ä–æ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è? ‚Äî –ú–æ–∂–µ—Ç –±—ã—Ç—å –∂–∏–¥–∫–æ—Å—Ç—å. –ü—Ä–æ–≤–µ—Ä—å –¥–∞–≤–ª–µ–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏–∑ –º–æ—á–∏.<br>
    –ü–ª–æ—Ö–æ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è? ‚Äî –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–∫—Å–∏–∫–æ–∑ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫–∞—è —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—è. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –≤—Ä–∞—á–æ–º.
    </p>

    <p><strong>ü•ó –ß—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ—Å?</strong><br>
    –ì–æ—Ä–º–æ–Ω—ã, –≥–µ–Ω–µ—Ç–∏–∫–∞, –¥–≤–æ–π–Ω—è, —Å—Ç—Ä–µ—Å—Å, –µ–¥–∞, —Å–æ–Ω ‚Äî –≤—Å—ë —ç—Ç–æ –≤–∞–∂–Ω–æ. –ù–æ —Ç—ã –Ω–µ –≤–∏–Ω–æ–≤–∞—Ç–∞, –µ—Å–ª–∏ –≤–µ—Å —Å–∫–∞—á–µ—Ç. –ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–π.
    </p>

    <p><strong>üö´ –ù–µ –¥–µ–ª–∞–π –≤–æ—Ç —ç—Ç–æ–≥–æ</strong><br>
    ‚ùå –ù–µ —Å–∞–¥–∏—Å—å –Ω–∞ –¥–∏–µ—Ç—É<br>
    ‚ùå –ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏<br>
    ‚ùå –ù–µ –≥–æ–Ω–∏—Å—å –∑–∞ ¬´–Ω–æ—Ä–º–æ–π¬ª ‚Äî —Ç—ã –∏ –µ—Å—Ç—å –Ω–æ—Ä–º–∞
    </p>

    <p><strong>üí° –°–æ–≤–µ—Ç—ã:</strong>
      <ul>
        <li>–í–∑–≤–µ—à–∏–≤–∞–π—Å—è —É—Ç—Ä–æ–º, –Ω–∞—Ç–æ—â–∞–∫</li>
        <li>–°–ª–µ–¥–∏ –∑–∞ —Ä–µ–∑–∫–∏–º–∏ —Å–∫–∞—á–∫–∞–º–∏ (–±–æ–ª—å—à–µ 2 –∫–≥ –∑–∞ –Ω–µ–¥–µ–ª—é)</li>
        <li>–í–µ—Å ‚Äî —ç—Ç–æ –Ω–µ –æ—Ü–µ–Ω–∫–∞. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–¥–∏–Ω –∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</li>
      </ul>
    </p>

    <p><em>üóíÔ∏è –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è:</em> <a href="https://gemotest.ru/info/spravochnik/telo-cheloveka/nabor-vesa-pri-beremennosti/?utm_source=chatgpt.com" target="_blank" rel="noopener noreferrer">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è</a></p>
  </div>

  <div class="disclaimer">
    ‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.
  </div>

  <script>
    let isInitial = true;
    let currentWeight = null;
    let weeksPregnant = 0;
    let lastEnteredDate = null;   // ‚Üê –¥–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞—Ç—ã

    const inputEl = document.getElementById("weightInput");
    const labelEl = document.getElementById("weightDateLabel");
    const submitBtn = document.querySelector(".submit-btn");
    let successLabel;

    function formatDate(date = new Date()) {
      return date.toLocaleDateString("ru-RU", {
        day: "numeric",
        month: "long",
        year: "numeric"
      });
    }

    function onWeightEdit(input) {
      input.classList.remove("placeholder");
    }

    function goBack() {
      window.location.href = "/main";
    }

    function adjustWeight(delta) {
      let val = parseFloat(inputEl.value.replace(",", "."));
      if (isNaN(val)) val = 0;
      val = Math.round((val + delta) * 10) / 10;
      inputEl.value = val.toFixed(1);
      inputEl.classList.remove("placeholder");
    }

    function insertHelperText(text) {
      const oldHelper = document.getElementById("weight-helper");
      if (oldHelper) oldHelper.remove();

      const helper = document.createElement("div");
      helper.id = "weight-helper";
      helper.textContent = text;
      helper.style.fontSize = "14px";
      helper.style.color = "#888";
      helper.style.marginTop = "12px";
      helper.style.textAlign = "left";

      document.querySelector(".weight-block").appendChild(helper);
    }

    function removeHelperText() {
      const oldHelper = document.getElementById("weight-helper");
      if (oldHelper) oldHelper.remove();
    }

    function showSuccessLabel(text) {
      if (successLabel) successLabel.remove();

      successLabel = document.createElement("div");
      successLabel.textContent = text;
      successLabel.style.fontSize = "14px";
      successLabel.style.color = "#888";
      successLabel.style.marginTop = "8px";
      successLabel.style.textAlign = "center";

      submitBtn.insertAdjacentElement("afterend", successLabel);

      setTimeout(() => {
        if (successLabel) successLabel.remove();
      }, 2000);
    }

    function showHeightInput() {
      document.getElementById("heightInputBlock").style.display = "block";
    }

    /* ‚ñº –í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê */
    function renderHeightDisplay(height) {
      const block = document.getElementById("heightDisplay");
      block.innerHTML = `
        <div>
          üìè –†–æ—Å—Ç: <strong>${height} —Å–º</strong>
          <button class="submit-btn" onclick="showHeightInput()">‚úèÔ∏è</button>
        </div>`;
      document.getElementById("heightInputBlock").style.display = "none";
    }

    /* After: weight.html (submitHeight without localStorage) */
    async function submitHeight() {
        const height = parseInt(document.getElementById("heightInput").value);
        const userId = sessionStorage.getItem("tg_user_id");

        if (!height || height < 100 || height > 250) {
            alert("–í–≤–µ–¥–∏—Ç–µ —Ä–æ—Å—Ç –æ—Ç 100 –¥–æ 250 —Å–º");
            return;
        }

        try {
            await fetch("/save_height", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userId, height })
            });
            // Immediately update the UI with the new height from input
            renderHeightDisplay(height);
        } catch (e) {
            console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–æ—Å—Ç–∞", e);
        }
    }

    /* After: weight.html (submitWeight saving all data to DB) */
    function submitWeight() {
        const value = parseFloat(inputEl.value.replace(",", "."));
        if (isNaN(value)) {
            alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å");
            return;
        }

        const today = new Date().toISOString().slice(0, 10);

              if (isInitial) {
              if (weeksPregnant >= 10) {
                  /* 1Ô∏è‚É£  –°–æ—Ö—Ä–∞–Ω—è–µ–º –ü–ï–†–í–´–ô (–∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π) –≤–µ—Å –≤ –ë–î ‚Äî NEW */
                  fetch("/save_weight", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                          user_id: sessionStorage.getItem("tg_user_id"),
                          weight: value,
                          date: today                // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
                      })
                  }).then(() => {
                      showSuccessLabel("–í–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");        // NEW
                      insertHelperText("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π –≤–µ—Å");
                  });

                  isInitial = false;                           // NEW ‚Äì –±–æ–ª—å—à–µ –Ω–µ ¬´–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫¬ª
                  submitBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
                  if (!isInitial) removeHelperText();
            } else {
                // Save initial weight to DB even if < 10 weeks
                fetch("/save_weight", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: sessionStorage.getItem("tg_user_id"),
                        weight: value,
                        date: today
                    })
                });
                showSuccessLabel("–í–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
                sessionStorage.setItem("weight_date", today);   // üëà –î–û–ë–ê–í–ò–¢–¨
                submitBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
                isInitial = false;
            }
        } else {
            // Save new weight entry to DB
            fetch("/save_weight", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_id: sessionStorage.getItem("tg_user_id"),
                    weight: value,
                    date: today
                })
            }).then(() => {
                // Reload data to update stats and chart
                fetch(`/load_user_data?user_id=${sessionStorage.getItem("tg_user_id")}`)
                    .then(res => res.json())
                    .then(data => {
                        const weeks = data.weeks || 0;
                        showWeightStats(data, weeks);
                    });
            });
            showSuccessLabel("–¢–µ–∫—É—â–∏–π –≤–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
            sessionStorage.setItem("weight_date", today);   // üëà –î–û–ë–ê–í–ò–¢–¨
            submitBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
            removeHelperText();
        }

        labelEl.textContent = "–°–µ–≥–æ–¥–Ω—è: " + formatDate();
        inputEl.classList.remove("placeholder");
        inputEl.value = value.toFixed(1);
    }

    function showWeightStats(data, weeksPregnant) {
      const gainEl = document.getElementById("gainLine");
      const normEl = document.getElementById("normLine");

      if (!data.weights || data.weights.length < 2) {
        document.getElementById("statsWrapper").style.display = "none";
        return;
      } else {
        document.getElementById("statsWrapper").style.display = "block";
      }

      const [startWeight, startDate] = data.weights[0];
      const [lastWeight, lastDate] = data.weights[data.weights.length - 1];

      const kgGain = (lastWeight - startWeight).toFixed(1);
      gainEl.innerHTML = `üìà –í—Å–µ–≥–æ –¥–æ–±–∞–≤–∏–ª–æ—Å—å: <strong>${kgGain} –∫–≥</strong>`;

    if (weeksPregnant < 10) {
      normEl.innerHTML = `‚ÑπÔ∏è –î–æ 10 –Ω–µ–¥–µ–ª—å –≤–µ—Å –º–æ–∂–µ—Ç –∫–æ–ª–µ–±–∞—Ç—å—Å—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.`;
    } else if (data.norm_info) {
      const min = data.norm_info.min_kg;
      const max = data.norm_info.max_kg;

      if (kgGain < min) {
        normEl.innerHTML = `üîî –í–æ–∑–º–æ–∂–Ω–æ, –≤–µ—Å –Ω–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã, —Å–æ–≤–µ—Ç—É–µ–º –ø—Ä–æ–∫–æ–Ω—Å—É—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –≤—Ä–∞—á–æ–º (< ${min} –∫–≥)`;
      } else if (kgGain > max) {
        normEl.innerHTML = `üîî –í–æ–∑–º–æ–∂–Ω–æ, –≤–µ—Å –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ –Ω–æ—Ä–º—ã, —Å–æ–≤–µ—Ç—É–µ–º –ø—Ä–æ–∫–æ–Ω—Å—É—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –≤—Ä–∞—á–æ–º (> ${max} –∫–≥)`;
      } else {
        normEl.innerHTML = `‚úÖ –í–∞—à –≤–µ—Å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è (${min}‚Äì${max} –∫–≥)`;
      }
      } else {
        normEl.innerHTML = `‚Äî`;
      }
      if (data.weights && data.weights.length >= 2) {
        renderWeightChart(data.weights);
      }
    }

    let chartInstance = null;

    function renderWeightChart(weights) {
      const ctx = document.getElementById('weightChart').getContext('2d');

      const labels = weights.map(entry => {
        const date = new Date(entry[1]);
        return date.toLocaleDateString("ru-RU", { day: '2-digit', month: 'short' });
      });

      const values = weights.map(entry => entry[0]);

      if (chartInstance) {
        chartInstance.destroy(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '–í–µ—Å (–∫–≥)',
            data: values,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: false }
          }
        }
      });
    }

    /* After: weight.html (using fetched data directly, no localStorage caching) */
    window.addEventListener("DOMContentLoaded", async () => {
        const today = new Date().toISOString().slice(0, 10);
        const userId = sessionStorage.getItem("tg_user_id");
        try {
            const res = await fetch(`/load_user_data?user_id=${userId}`);
            const data = await res.json();

            // Set weeksPregnant from data (or 0 if not available)
            weeksPregnant = data.weeks || 0;

            // Display user‚Äôs height if already saved
            if (data.height) {
                renderHeightDisplay(data.height);
            }

            // If an initial weight was recorded in DB, mark as not initial
            if (data.start_weight) {
                isInitial = false;
            }

            // If there are any weight entries, get the latest entry
            if (data.weights && data.weights.length > 0) {
                const lastEntry = data.weights[data.weights.length - 1];
                const lastWeight = lastEntry[0];
                const lastDate = lastEntry[1];
                currentWeight = lastWeight;
              lastEnteredDate = lastDate;       // —Å—Ç–∞–ª–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π
            }

            showWeightStats(data, weeksPregnant);
        } catch (e) {
            console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }

        if (weeksPregnant < 10) {
            // For pregnancies under 10 weeks, skip separate initial weight step
            isInitial = false;
            labelEl.textContent = "–°–µ–≥–æ–¥–Ω—è: " + formatDate();
            if (currentWeight !== null) {
                inputEl.value = currentWeight.toFixed(1);
                inputEl.classList.remove("placeholder");
                submitBtn.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å";
            } else {
                inputEl.placeholder = "‚Äì";
                inputEl.value = "";
                inputEl.classList.add("placeholder");
            }
            insertHelperText("–î–æ 10 –Ω–µ–¥–µ–ª—å –≤–µ—Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.");
        } else if (isInitial) {
            // Prompt for initial weight if not provided yet (>= 10 weeks)
            labelEl.textContent = "–í–≤–µ–¥–∏—Ç–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å:";
            insertHelperText("–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–µ—Å –¥–æ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏.");
            inputEl.placeholder = "‚Äì";
            inputEl.value = "";
            inputEl.classList.add("placeholder");
        } else {
            labelEl.textContent = "–°–µ–≥–æ–¥–Ω—è: " + formatDate();
            if (currentWeight !== null) {
                inputEl.value = currentWeight.toFixed(1);
                inputEl.classList.remove("placeholder");
            }
            // If the last recorded weight entry isn't from today, prompt for today's weight
            if (!lastEnteredDate || lastEnteredDate !== today) {
                insertHelperText("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –≤–µ—Å");
            }
        }
    });
  </script>
</body>
</html>