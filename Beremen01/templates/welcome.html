<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      background: white;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      opacity: 1;
      transition: opacity 1s ease;
    }

    .emoji {
      font-size: 96px;
      opacity: 0;
      animation: fadeIn 1s ease forwards 0.3s;
    }

    .text {
      font-size: 20px;
      color: #333;
      margin-top: 16px;
      opacity: 0;
      animation: fadeIn 1s ease forwards 0.8s;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="emoji">ü§∞</div>
  <div class="text">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤–∞—à–µ–π –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏</div>

  <script src="https://telegram.org/js/telegram-web-app.js?v=2"></script>
  <!-- After: welcome.html (fetching from DB to decide navigation) -->
  <script>
      // –í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞
      console.log("üîß –ó–∞–≥—Ä—É–∂–µ–Ω —Å–∫—Ä–∏–ø—Ç welcome.html v2.0");
      console.log("üåê Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω:", !!window.Telegram?.WebApp);
      
      const tg = window.Telegram?.WebApp;
      const user = tg?.initDataUnsafe?.user;
      let uid = null;
      
      console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:", user);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
      if (!user?.id) {
          // –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID
          uid = "test_user_12345";
          const username = "test_user";
          sessionStorage.setItem("tg_user_id", uid);
          sessionStorage.setItem("tg_username", username);
          sessionStorage.setItem("dev_mode", "true");
          
          // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          console.log("üîÑ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...");
          fetch("/register_user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: uid, username })
          }).then(res => {
              console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", res.status);
          }).catch(e => {
              console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", e);
          });
          
          console.log("üîß –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", uid);
      } else {
          // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º Telegram
          uid = user.id.toString();
          const username = user.username || "";
          sessionStorage.setItem("tg_user_id", uid);
          sessionStorage.setItem("tg_username", username);
          sessionStorage.setItem("dev_mode", "false");
          
          fetch("/register_user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: uid, username })
          });
      }

      // ‚è≥ After 2 seconds, determine next page via DB query
      setTimeout(async () => {
          console.log("üîß –¢–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª, uid:", uid);
          if (!uid) {
              console.log("‚ùå UID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ /choose");
              window.location.href = "/choose";
              return;
          }
          
          try {
              console.log("üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...");
              const res = await fetch(`/load_user_data?user_id=${uid}`);
              console.log("üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", res.status);
              
              if (!res.ok) {
                  throw new Error(`HTTP ${res.status}`);
              }
              
              const data = await res.json();
              console.log("üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", data);
              
              if (data.start_date) {
                  console.log("‚úÖ –î–∞—Ç–∞ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ /main");
                  window.location.href = "/main";
              } else {
                  console.log("üìÖ –î–∞—Ç–∞ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ /choose");
                  window.location.href = "/choose";
              }
          } catch (e) {
              console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
              console.log("üîÑ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ /choose –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏");
              window.location.href = "/choose";
          }
      }, 2000);
  </script>
</body>
</html>