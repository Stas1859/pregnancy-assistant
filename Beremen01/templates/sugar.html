<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∞—Ö–∞—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, sans-serif;
      background: #f2f3f5;
      color: #333;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    h2 {
      margin-top: 24px;
      font-size: 20px;
    }

    .info-block {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .sugar-block {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
      margin-bottom: 20px;
    }

    .sugar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .sugar-btn {
      font-size: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: #e0f0ff;
      color: #2aabee;
      cursor: pointer;
    }

    .sugar-input {
      font-size: 32px;
      width: 120px;
      text-align: center;
      border: none;
      background: transparent;
      outline: none;
      font-weight: bold;
      color: #333;
    }

    .sugar-input.placeholder {
      opacity: 0.5;
    }

    .submit-btn {
      margin-top: 12px;
      background: #2aabee;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 24px;
      font-size: 16px;
      cursor: pointer;
    }

    .disclaimer {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 32px;
    }
  </style>
</head>
<body>
  <div style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
    <button onclick="goBack()" style="background: none; border: none; font-size: 16px; color: #4f8fba; cursor: pointer; position: absolute; left: 0;">
      ‚Üê –ù–∞–∑–∞–¥
    </button>
    <h2 style="margin: 0 auto; text-align: center;">–°–∞—Ö–∞—Ä</h2>
  </div>

  <div class="info-block" id="questionBlock">
    <p>–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å –∫ –¥–∏–∞–±–µ—Ç—É –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —É—Ä–æ–≤–Ω–µ–º —Å–∞—Ö–∞—Ä–∞?</p>
    <button class="submit-btn" onclick="answerRisk(true)">–î–∞</button>
    <button class="submit-btn" onclick="answerRisk(false)">–ù–µ—Ç</button>
  </div>

  <div id="recommendationBlock" class="info-block" style="display: none;"></div>

  <div id="sugarInputBlock" class="sugar-block" style="display: none;">
    <div class="date" id="sugarDateLabel">–í–≤–µ–¥–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ (–º–º–æ–ª—å/–ª):</div>
    <div class="sugar-controls">
      <button class="sugar-btn" onclick="adjustSugar(-0.1)">‚àí</button>
      <input
        id="sugarInput"
        class="sugar-input placeholder"
        type="text"
        inputmode="decimal"
        placeholder="‚Äì"
        oninput="onSugarEdit(this)"
      />
      <button class="sugar-btn" onclick="adjustSugar(+0.1)">+</button>
    </div>
    <button class="submit-btn" onclick="submitSugar()">–í–Ω–µ—Å—Ç–∏</button>
  </div>

  <div id="statsWrapper" style="display: none;">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="info-block" id="statsBlock">
      <div id="sugarStatus">‚Äî</div>
    </div>
    <canvas id="sugarChart" style="max-width: 100%; margin-bottom: 20px;"></canvas>
  </div>
    <h2>–û –∫–æ–Ω—Ç—Ä–æ–ª–µ —Å–∞—Ö–∞—Ä–∞ –ø—Ä–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏</h2>
    <div class="info-block">
      <p><strong>ü§∞ –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–∞—Ö–∞—Ä–æ–º?</strong></p>
      <p>–î–∞–∂–µ –µ—Å–ª–∏ –¥–æ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ —É –≤–∞—Å –Ω–µ –±—ã–ª–æ –ø—Ä–æ–±–ª–µ–º —Å —É—Ä–æ–≤–Ω–µ–º –≥–ª—é–∫–æ–∑—ã, –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –µ–≥–æ –∫–æ–ª–µ–±–∞–Ω–∏—è. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –ø–æ—Å–ª–µ 24 –Ω–µ–¥–µ–ª–∏, –∫–æ–≥–¥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç —Ä–∏—Å–∫ –≥–µ—Å—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–∏–∞–±–µ—Ç–∞.</p>

      <p><strong>üìä –ö–∞–∫–∏–µ –Ω–æ—Ä–º—ã?</strong></p>
      <ul>
        <li>–ù–∞—Ç–æ—â–∞–∫: 3.3‚Äì5.1 –º–º–æ–ª—å/–ª</li>
        <li>–ß–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ –µ–¥—ã: –Ω–µ –±–æ–ª–µ–µ 7.0‚Äì7.8 –º–º–æ–ª—å/–ª</li>
      </ul>

      <p><strong>üîÅ –ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å?</strong><br>
      –ï—Å–ª–∏ –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ—Ç ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å 1 —Ä–∞–∑ –≤ 2‚Äì4 –Ω–µ–¥–µ–ª–∏.<br>
      –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ ‚Äî 2‚Äì3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –≤—Ä–∞—á–∞.</p>

      <p><strong>üìå –ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∏–∑–º–µ—Ä–µ–Ω–∏—é?</strong><br>
      –ò–∑–º–µ—Ä—è–π—Ç–µ —Å–∞—Ö–∞—Ä —É—Ç—Ä–æ–º –Ω–∞—Ç–æ—â–∞–∫ –∏–ª–∏ —á–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ –µ–¥—ã. –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ—Ç–º–µ—á–∞–π—Ç–µ, –µ—Å–ª–∏ –±—ã–ª–∏ —Ä–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ –∏–ª–∏ –ø–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ.</p>

      <p><em>–ò—Å—Ç–æ—á–Ω–∏–∫: <a href="https://minzdrav.gov.ru/ministry/programms/detskoe-zdorove/gestatsionnyy-diabet" target="_blank" rel="noopener noreferrer">–ú–∏–Ω–∑–¥—Ä–∞–≤ –†–§ ‚Äî –ì–µ—Å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∏–∞–±–µ—Ç</a></em></p>
    </div>

    <div class="disclaimer">
      ‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.
    </div>

    <script>
      let hasRisk = null;
      const inputEl = document.getElementById("sugarInput");
      const statusEl = document.getElementById("sugarStatus");
      const chartEl = document.getElementById("sugarChart").getContext("2d");
      let chartInstance = null;

      function goBack() {
        window.location.href = "/main";
      }

      function answerRisk(risk) {
        hasRisk = risk;
        localStorage.setItem("sugar_risk", risk ? "1" : "0");

        showQuestionAnsweredState();
      }

      function showQuestionAnsweredState() {
        document.getElementById("questionBlock").style.display = "none";
        document.getElementById("recommendationBlock").style.display = "block";
        document.getElementById("sugarInputBlock").style.display = "block";

        const riskStored = localStorage.getItem("sugar_risk") === "1";
        document.getElementById("recommendationBlock").innerHTML = riskStored
          ? "<p>ü©∫ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–∞—Ö–∞—Ä 2‚Äì3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–∞—á–∞.</p>"
          : "<p>ü©∫ –ë–µ–∑ –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–∞—Ö–∞—Ä 1 —Ä–∞–∑ –≤ 2‚Äì4 –Ω–µ–¥–µ–ª–∏, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ 24 –Ω–µ–¥–µ–ª–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏.</p>";
      }

      function adjustSugar(delta) {
        let val = parseFloat(inputEl.value.replace(",", "."));
        if (isNaN(val)) val = 0;
        val = Math.round((val + delta) * 10) / 10;
        inputEl.value = val.toFixed(1);
        inputEl.classList.remove("placeholder");
      }

      function onSugarEdit(input) {
        input.classList.remove("placeholder");
      }

      function submitSugar() {
        const value = parseFloat(inputEl.value.replace(",", "."));
        if (isNaN(value)) {
          alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞");
          return;
        }

        const today = new Date().toISOString().slice(0, 10);
        localStorage.setItem("sugar_date", today);
        localStorage.setItem("sugar_value", value);

        fetch("/save_sugar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: sessionStorage.getItem("tg_user_id"),
            date: today,
            sugar: value
          })
        });

        let statusText = "";
        if (value < 3.3) {
          statusText = "üîª –£—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.";
        } else if (value <= 5.1) {
          statusText = "‚úÖ –£—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –≤ –Ω–æ—Ä–º–µ.";
        } else if (value <= 7.0) {
          statusText = "‚ÑπÔ∏è –í–æ–∑–º–æ–∂–µ–Ω –≥–µ—Å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∏–∞–±–µ—Ç. –û–±—Å—É–¥–∏—Ç–µ —ç—Ç–æ —Å –≤—Ä–∞—á–æ–º.";
        } else {
          statusText = "üî∫ –£—Ä–æ–≤–µ–Ω—å —Å–∞—Ö–∞—Ä–∞ –≤—ã—Å–æ–∫–∏–π. –°—Ä–æ—á–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.";
        }

        localStorage.setItem("sugar_status", statusText);
        statusEl.textContent = statusText;

        checkAndShowStats();
      }

      async function checkAndShowStats() {
        const userId = sessionStorage.getItem("tg_user_id");
        const res = await fetch(`/load_sugar_data?user_id=${userId}`);
        const data = await res.json();
        const entries = data.entries || [];

        if (entries.length >= 2) {
          document.getElementById("statsWrapper").style.display = "block";
          renderChart(entries);
        }
      }

      function renderChart(entries) {
        const labels = entries.map(e => new Date(e[0]).toLocaleDateString("ru-RU", { day: "2-digit", month: "short" }));
        const values = entries.map(e => e[1]);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(chartEl, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "–°–∞—Ö–∞—Ä (–º–º–æ–ª—å/–ª)",
              data: values,
              tension: 0.3,
              borderWidth: 2,
              pointRadius: 3,
              fill: false
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: false } }
          }
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        const today = new Date().toISOString().slice(0, 10);
        const lastDate = localStorage.getItem("sugar_date");
        const lastValue = localStorage.getItem("sugar_value");
        const riskStored = localStorage.getItem("sugar_risk");

        if (riskStored !== null) {
          showQuestionAnsweredState();
        }

        if (lastValue && lastDate === today) {
          inputEl.value = lastValue;
          inputEl.classList.remove("placeholder");

          const savedStatus = localStorage.getItem("sugar_status");
          if (savedStatus) {
            statusEl.textContent = savedStatus;
          }
        }

        checkAndShowStats();
      });
    </script>
  </body>
  </html>