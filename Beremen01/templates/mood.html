<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, sans-serif;
      background: #f2f3f5;
      color: #333;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }
    .info-block {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    h2 {
      font-size: 20px;
      margin-top: 24px;
    }
    .emoji-row {
      display: flex;
      justify-content: center;
      gap: 24px;
      font-size: 36px;
      margin-top: 12px;
    }
    .emoji {
      cursor: pointer;
      opacity: 0.5;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    .emoji.selected {
      opacity: 1;
      transform: scale(1.2);
    }
    #moodChart {
      max-width: 100%;
      margin-bottom: 20px;
    }
    canvas.hidden {
      display: none;
    }
  </style>
</head>
<body>

  <div style="display: flex; align-items: center; margin-bottom: 12px; position: relative;">
    <button onclick="window.location.href='/main'" style="background: none; border: none; font-size: 16px; color: #4f8fba; cursor: pointer; position: absolute; left: 0;">
      ‚Üê –ù–∞–∑–∞–¥
    </button>
    <h2 style="margin: 0 auto; text-align: center;">–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</h2>
  </div>

  <div class="info-block">
    <p>–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ—ë <strong>–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</strong> –∏ <strong>—Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</strong> ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–º–µ—á–∞—Ç—å –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –¥–µ–ª–∏—Ç—å—Å—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º–∏ —Å –≤—Ä–∞—á–æ–º.</p>
  </div>

  <div class="info-block" id="moodBlock">
    <p><strong>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</strong></p>
    <div class="emoji-row" id="moodOptions">
      <span class="emoji" data-value="1">üòû</span>
      <span class="emoji" data-value="2">üòê</span>
      <span class="emoji" data-value="3">üòä</span>
    </div>
  </div>

  <div class="info-block" id="wellbeingBlock">
    <p><strong>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</strong></p>
    <div class="emoji-row" id="wellbeingOptions">
      <span class="emoji" data-value="1">ü§í</span>
      <span class="emoji" data-value="2">üòå</span>
      <span class="emoji" data-value="3">üí™</span>
    </div>
  </div>

  <canvas id="moodChart" class="hidden"></canvas>

  <h2>–ó–∞—á–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</h2>
  <div class="info-block">

    <p><strong>üß† –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø—Å–∏—Ö–∏–∫–æ–π –≤–æ –≤—Ä–µ–º—è –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏?</strong></p>
    <p>–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –≤—Ä–µ–º—è –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω –≤ —Ç–µ–ª–µ, –Ω–æ –∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–æ–¥–æ–≤–æ—Ä–æ—Ç–∞. –ú–µ–Ω—è–µ—Ç—Å—è –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω, –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ö–∏, –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è, –∞ –∏–Ω–æ–≥–¥–∞ –∏ –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë ¬´—á–µ—Ä–µ–∑ –∫—Ä–∞–π¬ª. –ò —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.</p>
    <p>–î–∞–∂–µ —É —Å–∞–º—ã—Ö —Å–ø–æ–∫–æ–π–Ω—ã—Ö –∂–µ–Ω—â–∏–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å:</p>
    <ul>
      <li>—Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è;</li>
      <li>–ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ –ø–µ—Ä–≤–æ–º –∏ —Ç—Ä–µ—Ç—å–µ–º —Ç—Ä–∏–º–µ—Å—Ç—Ä–∞—Ö);</li>
      <li>–±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞;</li>
      <li>–∏–Ω–æ–≥–¥–∞ ‚Äî –∞–ø–∞—Ç–∏—è –∏–ª–∏ —Å–ª–µ–∑–ª–∏–≤–æ—Å—Ç—å –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã.</li>
    </ul>
    <p><strong>üìå –í–∞–∂–Ω–æ:</strong> –≤—Å—ë —ç—Ç–æ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ ¬´—á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫¬ª. –ü—Ä–æ—Å—Ç–æ –ø—Å–∏—Ö–∏–∫–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –Ω–æ–≤–æ–π —Ä–æ–ª–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –û—Å–æ–±–µ–Ω–Ω–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∂–µ–Ω—â–∏–Ω—ã —Å —Ç–æ–∫—Å–∏–∫–æ–∑–æ–º, –æ—Å–ª–æ–∂–Ω–µ–Ω–∏—è–º–∏ –∏–ª–∏ –¥–≤–æ–π–Ω–µ–π.</p>

    <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0;">

    <p><strong>‚ù§Ô∏è –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º?</strong></p>
    <p>–ï—Å–ª–∏ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏–ª–∏ –≥—Ä—É—Å—Ç—å –∑–∞—Ç—è–≥–∏–≤–∞—é—Ç—Å—è, —ç—Ç–æ –º–æ–∂–µ—Ç:</p>
    <ul>
      <li>—É—Ö—É–¥—à–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–≤—ã—Å–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É—Å–∏–ª–∏—Ç—å —Ç–æ–∫—Å–∏–∫–æ–∑);</li>
      <li>–ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ –º–∞–ª—ã—à–∞ ‚Äî —Å—Ç—Ä–µ—Å—Å –≤–ª–∏—è–µ—Ç –Ω–∞ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –∏ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ;</li>
      <li>–ø–æ–º–µ—à–∞—Ç—å –º–∞–º–µ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–≤—è–∑—å —Å —Ä–µ–±—ë–Ω–∫–æ–º –ø–æ—Å–ª–µ —Ä–æ–∂–¥–µ–Ω–∏—è.</li>
    </ul>
    <p>–ù–æ —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –º–∞–º–∞ —Å–∞–º–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è —Ö—É–∂–µ. –£—Å—Ç–∞—ë—Ç, —Ç—Ä—É–¥–Ω–µ–µ –æ—Ç–¥—ã—Ö–∞–µ—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.</p>

    <hr style="border: none; border-top: 1px solid #eee; margin: 16px 0;">

    <p><strong>üîß –ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å?</strong></p>
    <p>–ê–≤—Ç–æ—Ä—ã —Å—Ç–∞—Ç—å–∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞—é—Ç: –ø—Å–∏—Ö–æ—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –≤–∞–∂–Ω–µ–π—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è –±–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –∏ –∑–∞ –Ω–∏–º –º–æ–∂–Ω–æ –±–µ—Ä–µ–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å.</p>
    <p>–ü–æ–º–æ–≥–∞–µ—Ç:</p>
    <ul>
      <li>–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏ —Å–µ–º—å–∏;</li>
      <li>–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è;</li>
      <li>–ø—Ä–æ–≥—É–ª–∫–∏, –π–æ–≥–∞, —Ç—ë–ø–ª–æ–µ –æ–±—â–µ–Ω–∏–µ;</li>
      <li>—Ä–µ–∂–∏–º —Å–Ω–∞ –∏ –æ—Ç–¥—ã—Ö–∞;</li>
      <li>–ø–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è–º ‚Äî –ª—ë–≥–∫–∞—è –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–æ–∑–Ω–∞—è –ø–æ–º–æ—â—å (—Ç–æ–ª—å–∫–æ —Å –≤—Ä–∞—á–æ–º).</li>
    </ul>

    <p><strong>üì≤ –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ?</strong></p>
    <p>–ö–∞–∂–¥–∞—è –∫–æ—Ä–æ—Ç–∫–∞—è –æ—Ç–º–µ—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–º–∞–π–ª–∏–∫) ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å–µ–±—è –≤ —Ä—É—Ç–∏–Ω–µ, –∑–∞–º–µ—Ç–∏—Ç—å, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Ç—Ä–µ–≤–æ–∂–∏—Ç, –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —ç—Ç–∏–º —Å –≤—Ä–∞—á–æ–º. –≠—Ç–æ –∑–∞–±–æ—Ç–∞, –∞ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å.</p>

    <p><strong>üíö –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –Ω–µ —Ç–µ—Å—Ç –Ω–∞ —Å–∏–ª—É –≤–æ–ª–∏.</strong><br>
    –°–ª–µ–¥–∏—Ç—å –∑–∞ —Å–≤–æ–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º ‚Äî —ç—Ç–æ –≤–∑—Ä–æ—Å–ª—ã–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π —à–∞–≥. –î–ª—è —Å–µ–±—è –∏ –¥–ª—è –º–∞–ª—ã—à–∞.</p>

    <p style="font-size: 13px; color: #777; margin-top: 16px;">
      üìù <a href="https://www.rmj.ru/articles/nevrologiya/Psihoemocionalynye_rasstroystva__pri_beremennosti__Neobhodimosty_ih_korrekcii/?utm_source=chatgpt.com" target="_blank" rel="noopener noreferrer">
        –ò—Å—Ç–æ—á–Ω–∏–∫: –†–æ—Å—Å–∏–π—Å–∫–∏–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª (rmj.ru)
      </a>
    </p>

  </div>

  <script>
    const userId = sessionStorage.getItem("tg_user_id");
    const date = new Date().toISOString().slice(0, 10);
    const moodOptions = document.querySelectorAll("#moodOptions .emoji");
    const wellOptions = document.querySelectorAll("#wellbeingOptions .emoji");
    const chartCanvas = document.getElementById("moodChart");

    let chartInstance = null;

    function sendMoodData(mood, wellbeing) {
      fetch("/save_mood", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, date, mood, wellbeing })
      }).then(() => {
        sessionStorage.setItem("wellbeing_date", date);
        chartCanvas.classList.remove("hidden");  // –ü–æ—è–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
        loadChart();
      });
    }

    function selectEmoji(group, value) {
      group.forEach(e => e.classList.remove("selected"));
      const selected = [...group].find(e => e.dataset.value == value);
      if (selected) selected.classList.add("selected");
    }

    function setupEmojiBlock(group, key) {
      group.forEach(el => {
        el.addEventListener("click", () => {
          const value = el.dataset.value;
          sessionStorage.setItem(key, value);
          selectEmoji(group, value);

          const mood = sessionStorage.getItem("mood") || null;
          const wellbeing = sessionStorage.getItem("wellbeing") || null;

          if (mood && wellbeing) {
            sendMoodData(parseInt(mood), parseInt(wellbeing));
          }
        });
      });
    }

    setupEmojiBlock(moodOptions, "mood");
    setupEmojiBlock(wellOptions, "wellbeing");

    function loadChart() {
      fetch(`/load_mood_data?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          fetch(`/load_user_data?user_id=${userId}`)
            .then(res => res.json())
            .then(userData => {
              const entries = data.entries || [];

              const startDate = userData.start_date || (userData.weights?.[0]?.[1]);
              if (!startDate) return;

              // –î–æ–±–∞–≤–∏–º —Ç–æ—á–∫—É "–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" –Ω–∞ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏
              const labels = [startDate, ...entries.map(row => row[0])];
              const moodData = [2, ...entries.map(row => row[1])];
              const wellData = [2, ...entries.map(row => row[2])];

              chartCanvas.classList.remove("hidden");

              if (chartInstance) {
                chartInstance.destroy(); // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
              }

              chartInstance = new Chart(chartCanvas, {
                type: 'line',
                data: {
                  labels,
                  datasets: [
                    {
                      label: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                      data: moodData,
                      borderWidth: 2,
                      tension: 0.3
                    },
                    {
                      label: '–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',
                      data: wellData,
                      borderWidth: 2,
                      tension: 0.3
                    }
                  ]
                },
                options: {
                  responsive: true,
                  plugins: { legend: { position: 'top' } },
                  scales: {
                    y: {
                      suggestedMin: 0,
                      suggestedMax: 3,
                      ticks: {
                        callback: function(value) {
                          return value === 1 ? "üòû" : value === 2 ? "üòê" : value === 3 ? "üòä" : value;
                        }
                      }
                    }
                  }
                }
              });
            });
        });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadChart();

      const mood = sessionStorage.getItem("mood");
      const well = sessionStorage.getItem("wellbeing");
      if (mood) selectEmoji(moodOptions, mood);
      if (well) selectEmoji(wellOptions, well);
    });
  </script>
  <div class="disclaimer" style="font-size: 12px; color: #999; text-align: center; margin-top: 32px;">
    ‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É.
  </div>
</body>
</html>